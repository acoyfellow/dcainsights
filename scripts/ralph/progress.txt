## Codebase Patterns

- Always verify ALL linked pages return 200 before pushing homepage updates
- Missing icon imports cause 500 errors (e.g., Check, ArrowRight, ShareButtons)
- User tier system: use `isPro` from `$lib/stores/user` for Pro/Premium checks
- Export functionality: use Blob + URL.createObjectURL for client-side CSV downloads

## 2026-01-07 - MON-001

**What was implemented**
- Added Export CSV button to S&P 500 DCA Calculator
- Pro/Premium users can download CSV directly
- Free users are redirected to /pricing with upgrade parameter
- Button shows lock icon for non-Pro users

**Files changed**
- src/routes/sp500-dca-calculator/+page.svelte
- scripts/ralph/prd.json (marked MON-001 complete)

**Learnings**
- User tier is reactive: use `$isPro` in Svelte templates
- Stripe checkout flow: POST to /api/stripe/checkout with planId and billingInterval
- No server-side code needed for export - can generate CSV entirely client-side

**Bug fixes also included**
- Fixed /education page: added missing Check icon import
- Fixed /blog/ultimate-guide-to-dollar-cost-averaging: added missing ArrowRight import and ShareButtons component import

## 2026-01-07 - MON-002 (partial - needs KV/R2)

**What was implemented**
- Shareable Report Link with URL-encoded state (base64)
- User clicks "Share" to copy report link with scenario parameters
- When visiting a report link, parameters are decoded and applied automatically
- Clean notification banner shows when report is loaded

**Files changed**
- src/routes/sp500-dca-calculator/+page.svelte

**Learnings**
- URL-encoded state: btoa(JSON.stringify(scenario)) for encoding, JSON.parse(atob()) for decoding
- No storage needed for basic shareable links - state lives in URL
- For production with many scenarios, would want KV/R2 storage with short IDs

**Not yet complete**
- PRD requires "Storage uses KV or R2" - need to add Cloudflare KV binding
- Would need to update wrangler.jsonc with KV namespace
- For now, using URL-encoded state as lightweight alternative

## 2026-01-07 - OPS-001

**What was implemented**
- Created GitHub Action workflow for deploy + cache purge
- Workflow runs on push to main
- Deploys to Cloudflare Pages using cloudflare/pages-action
- After deploy, purges cache for key pages (/, /sitemap.xml, all tool routes)
- Fails loudly if CLOUDFLARE_API_TOKEN or CLOUDFLARE_ZONE_ID missing

**Files changed**
- .github/workflows/deploy.yml (new file)
- AGENT.md (added CLOUDFLARE_ZONE_ID to secrets)
- scripts/ralph/prd.json (marked OPS-001 complete)

**Learnings**
- Cloudflare cache purge requires CLOUDFLARE_ZONE_ID (not just ACCOUNT_ID)
- Use Cloudflare API v4: POST /zones/:zone_id/purge_cache
- GitHub Actions secrets: CLOUDFLARE_API_TOKEN, CLOUDFLARE_ZONE_ID
- Workflow needs to fail explicitly if env vars missing

**Required secrets to add in GitHub**
- CLOUDFLARE_ZONE_ID (new - for cache purge API calls)
- Existing: CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID

## 2026-01-07 - LEADS-001

**What was implemented**
- Added "Email Me This Report" button to S&P 500 DCA Calculator
- Modal form captures email address
- Submits to existing /api/newsletter/subscribe endpoint
- Shows success confirmation after subscription
- Clean, accessible modal with form validation

**Files changed**
- src/routes/sp500-dca-calculator/+page.svelte

**Learnings**
- Reuse existing newsletter API for email capture (no new backend needed)
- Modal pattern: fixed overlay, centered content, close on backdrop click
- Form validation: regex for email format, disable submit while submitting
- Use existing toast notifications for feedback

## 2026-01-13 - S1

**What was implemented**
- Bootstrapped Ralph automation scaffold (AGENTS.md, state files, guard, workflow docs)

**Files changed**
- AGENTS.md
- scripts/ralph/prd.json
- scripts/ralph/progress.txt
- scripts/ralph/constraints.json
- scripts/ralph/failure.json
- scripts/ralph/guard.sh
- .opencode/opencode.json
- .github/workflows/ralph.yml
- README.md

**Learnings**
- Guard uses constraints.json for file/line limits and forbidden paths
- Failure handling increments `consecutiveFailures` and can pause the loop when limits are exceeded
